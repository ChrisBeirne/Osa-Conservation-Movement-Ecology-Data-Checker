---
title: "SCBI Tree Disease Guide"
output: pdf_document
author: Isabella Dangler & Kristina J. Anderson-Teixeira

header-includes:  \usepackage{float}
                  \usepackage{caption}
                  \captionsetup[figure]{labelformat=empty}
                  \captionsetup[table]{labelformat=empty}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

## latest complete survey
# latest_year = 2021

## pull tree species ecology from GitHub and for species names, life form, and IUCN status 
# tree_sp_ecology<-read.csv("https://raw.githubusercontent.com/SCBI-ForestGEO/SCBI-ForestGEO-Data/master/species_lists/Tree%20ecology/SCBI_ForestGEO_sp_ecology.csv")
# tree_index <- tree_sp_ecology$life_form == "tree" | tree_sp_ecology$life_form == "small tree" | tree_sp_ecology$life_form == "shrub or small tree" # index for trees (trees and small trees)

# read in and pull info from latest mortality census summary
mortality_by_species<-read.csv("https://raw.githubusercontent.com/SCBI-ForestGEO/SCBImortality/main/R_results/mortrates_and_agbmort_by_species.csv")
mortality_rate_by_species_latest <- mortality_by_species[ which(mortality_by_species$variable=='mortality_rates' & mortality_by_species$survey_year == max(mortality_by_species$survey_year)),] # keep mortality rates and only last year
names(mortality_rate_by_species_latest)[names(mortality_rate_by_species_latest) == 'sp'] <- 'Tree.species.code'
mortality_rate_by_species_latest$n.living <- mortality_rate_by_species_latest$N0 - mortality_rate_by_species_latest$n_died
  
# read in and manipulate tree- disease matrix
TDmatrix <- read.csv("matrix.csv")
n_FIP_by_species <- colSums (TDmatrix[3:ncol(TDmatrix)], na.rm = FALSE, dims = 1) #number of forest insects & pathogens
n_EFIP_by_species <- colSums (TDmatrix[which(TDmatrix$exotic==1),3:ncol(TDmatrix)], na.rm = FALSE, dims = 1) #number of exotic forest insects & pathogens

# read in species concerns status to create tree_species_summary
tree_species_summary <- read.csv("https://raw.githubusercontent.com/SCBI-ForestGEO/SCBImortality/main/R_results/concern_status.csv") 
names(tree_species_summary)[names(tree_species_summary) %in% 'spcode'] <- 'Tree.species.code'
names(tree_species_summary)[names(tree_species_summary) %in% 'IUCN_red_list_status'] <- 'IUCN.status'
## fill in numbers of pests/pathogens from matrix
tree_species_summary$n.FIP<-n_FIP_by_species[match(tree_species_summary$Tree.species.code, names(n_FIP_by_species))] # this assumes same species order as matrix.csv
tree_species_summary$n.EFIP<-n_EFIP_by_species[match(tree_species_summary$Tree.species.code, names(n_EFIP_by_species))]  # this assumes same species order as matrix.csv

## merge with mortality_rate data frame, then rearrange and delete unwanted columns. 
tree_species_summary <- cbind(tree_species_summary, mortality_rate_by_species_latest[match(tree_species_summary$Tree.species.code, mortality_rate_by_species_latest$Tree.species.code),])  # merge tables

## fill in overall concern level based on other fields
tree_species_summary$overall <- NA 
#1. If IUCN Red List status was anything other than "Least Concern", the species was flagged as high concern
tree_species_summary$overall[!tree_species_summary$IUCN.status %in% "Least concern" ] <- "H"

#2. If an exotic pest or disease with high / moderate lethality was known to be present in region, any species affected by that pest/ disease was flagged as H/M concern.
  #This one would be more complicated to code, as it would require creating a field on pest/disease lethality. For now, I'll implement a manual patch (see #5 below)
# tree_species_summary$overall[!tree_species_summary$Tree.species.code %in% "chvi" ] <- "H"

#3. If either mortality rate or AU concern level was M or H, overall concern was assigned to match the highest concern level, but lowered one level in the case of species with <50 individuals in the plot and only one M or H ranking.
tree_species_summary$overall[which((tree_species_summary$IUCN.status %in% "Least concern" | is.na(tree_species_summary$IUCN.status)) & (tree_species_summary$mortality_status %in% "H" | tree_species_summary$AU_status %in% "H") & tree_species_summary$n.living >= 50) ] <- "H"

tree_species_summary$overall[which((tree_species_summary$IUCN.status %in% "Least concern" | is.na(tree_species_summary$IUCN.status)) & (tree_species_summary$mortality_status %in% "H" | tree_species_summary$AU_status %in% "H") & tree_species_summary$n.living < 50) ] <- "M"

tree_species_summary$overall[which((tree_species_summary$IUCN.status %in% "Least concern" | is.na(tree_species_summary$IUCN.status)) & (tree_species_summary$mortality_status %in% "M" & !tree_species_summary$AU_status %in% "H") | (tree_species_summary$AU_status %in% "M" & !tree_species_summary$mortality_status %in% "H")  & tree_species_summary$n.living >= 50) ] <- "M"

tree_species_summary$overall[which((tree_species_summary$IUCN.status %in% "Least concern" | is.na(tree_species_summary$IUCN.status)) & (tree_species_summary$mortality_status %in% "M" & !tree_species_summary$AU_status %in% "H") | (tree_species_summary$AU_status %in% "M" & !tree_species_summary$mortality_status %in% "H")  & tree_species_summary$n.living < 50) ] <- "L"

#4. If IUCN Red List status was anything other than "Least Concern", there were no known highly lethal exotic pests or diseases present, and both mortality and AU concern levels were low, the species was flagged as low concern.
tree_species_summary$overall[which((tree_species_summary$IUCN.status %in% "Least concern" | is.na(tree_species_summary$IUCN.status)) & tree_species_summary$mortality_status %in% "L" & tree_species_summary$AU_status %in% "L") ] <- "L"

#5. Manual patches
tree_species_summary$overall[which(tree_species_summary$Tree.species.code %in% "chvi") ] <- "H"


# keep only columns we want and in specific order
tree_species_summary = tree_species_summary [, c("Tree.species.code", "life_form", "IUCN.status","n.living","n.FIP","n.EFIP","mortality_status","AU_status","overall")] 

## save latest version
write.csv(tree_species_summary, "tree_species_summary.csv", row.names = FALSE) # re-save file with latest numbers

## pare down table to include only trees for presentation in this document
tree_species_summary <- tree_species_summary[tree_species_summary$life_form %in% "tree",]# include only trees
tree_species_summary$life_form <- NULL
```

# Introduction

The aim of this guide is to identify tree species of concern within the SCBI ForestGEO plot, and the diseases that are most likely to affect them, so that we can properly identify the causes of decline.

# Methods & Definitions

## Tree species concern levels

We assigned concern levels -- high (H), moderate (M), or low (L) -- to each tree species based on results of the SCBI ForestGEO mortality census, IUCN status, and the presence and lethally of pest and pathogen species.

Concern level based on observed tree mortality rates alone was defined as follows:

Concern level based on the fraction of alive but unhealthy ("AU" status) trees observed in the latest census was defined as follows:

Overall concern level was determined as follows:

1. If IUCN Red List status was anything other than "Least Concern", the species was flagged as high concern
2. If an exotic pest or disease with high / moderate lethality was known to be present in region, any species affected by that pest/ disease was flagged as H/M concern.
3. If either mortality rate or AU concern level was M or H, overall concern was assigned to match the highest concern level, but lowered one level in the case of species with <50 individuals in the plot and only one M or H ranking.
4. If IUCN Red List status was anything other than "Least Concern", there were no known highly lethal exotic pests or diseases present, and both mortality and AU concern levels were low, the species was flagged as low concern.

## Identifying tree species - disease pairs

\newpage
# Tree Species of Concern
**Table 1. Summary of the health/ mortality status of all tree species in the SCBI ForestGEO plot.** Included is IUCN status, n of living individuals $\ge$ 10 cm DBH in the SCBI ForestGEO plot, numbers of known species of forest insects or pathogens (FIP) and exotic FIP (EFIP) affecting the species, levels of concern based on mortality rates and "alive-unhealthy" (AU) status, and overall level of concern based on these metrics. Codes: H = high, M = moderate; L = low. Tree species codes are defined in the document [SCBI_ForestGEO_sp_ecology.csv](https://github.com/SCBI-ForestGEO/SCBI-ForestGEO-Data/blob/master/species_lists/Tree%20ecology/SCBI_ForestGEO_sp_ecology.csv).
```{r tree_species_summary , echo=FALSE}

names(tree_species_summary) <- stringr::str_replace_all(names(tree_species_summary), "\\.|_", " ")
tree_species_summary[is.na(tree_species_summary)]<- "" #replace NAs with blanks

library(knitr)
library(kableExtra)
knitr::kable(tree_species_summary,
             format = "latex", booktabs = TRUE,  escape = F, longtable = TRUE,row.names = F) %>%
  kableExtra::kable_styling(full_width = TRUE, latex_options=c("repeat_header")) %>%
  add_header_above(c( " "= 5, "current concern level" = 3 )) %>% # paste(as.character(latest_year),"concern level")
  column_spec(1, width = "1cm") %>% 
  column_spec(2, width = "4cm") %>% 
  column_spec(3:8, width = "1.2cm") %>% 
  row_spec(1:nrow(tree_species_summary)-1,hline_after=T) %>%
  row_spec(which(tree_species_summary$overall=="H"),  bold = T, color = "red") %>%
  row_spec(which(tree_species_summary$overall=="M"),  bold = T, color = "orange") %>%
  kable_styling(bootstrap_options = "striped", font_size = 9) %>%
  kable_styling(latex_options = c("scale_down", "hold_position"), protect_latex = T) 


```

\newpage
# Tree- Disease Matrix
**Table 2. Matrix of forest insects and pathogens likely to occur at the SCBI ForestGEO plot, and the tree taxa they affect.** Tree species codes are defined in the document [SCBI_ForestGEO_sp_ecology.csv](https://github.com/SCBI-ForestGEO/SCBI-ForestGEO-Data/blob/master/species_lists/Tree%20ecology/SCBI_ForestGEO_sp_ecology.csv).
```{r matrix , echo=FALSE}

names(TDmatrix)[2] <- ""
TDmatrix <- TDmatrix[, c(1,2 which(names(TDmatrix) %in% tree_species_summary$Tree.species.code))] # keep only species shown in table 1

break_row = ceiling((ncol(TDmatrix)-2)/2)
TDmrowsum1 <- rowSums(TDmatrix[,3:break_row])
TDmrowsum2 <- rowSums(TDmatrix[,(break_row+1):ncol(TDmatrix)])
TDmatrix1 <- TDmatrix[TDmrowsum1>0,1:break_row]
TDmatrix2 <- TDmatrix[TDmrowsum2>0,c(1:2,(break_row+1):ncol(TDmatrix))]

TDconcern_index=paste0("",tree_species_summary$overall)
TDconcern_index1 <- TDconcern_index[1:(break_row-1)]
TDconcern_index1 <- TDconcern_index[c(1,1:(break_row-2))]
TDconcern_index2 <- TDconcern_index[c(1,(break_row-1):(ncol(TDmatrix)-2))]

library(knitr)
library(kableExtra)
knitr::kable(TDmatrix1[2:ncol(TDmatrix1)],
             caption = "Part 1/2: Tree species codes ACNE-FRPE",
             format = "latex", booktabs = TRUE,  escape = F, longtable = TRUE,row.names = F) %>%
  kableExtra::kable_styling(full_width = TRUE, latex_options=c("repeat_header")) %>%
  row_spec(0, bold = F, angle = 90) %>%
  row_spec(which(TDmatrix1$exotic==1), bold = TRUE) %>%
  row_spec(1:nrow(TDmatrix1)-1,hline_after=T) %>%
  column_spec(1, width = "5.27cm") %>% 
  column_spec(2:ncol(TDmatrix1), width = ".03cm", border_left = F) %>%
  #column_spec(which(TDconcern_index1=="H"),  color = "red") %>%
  #column_spec(which(TDconcern_index1=="M"),  color = "orange") %>%
  kable_styling(bootstrap_options = "striped", font_size = 9) %>%
  kable_styling(latex_options = c("scale_down", "hold_position"), protect_latex = T) 


```
\newpage

```{r matrix2 , echo=FALSE}


knitr::kable(TDmatrix2[2:ncol(TDmatrix2)],
             caption = "Part 2/2: Tree species codes JUCI-ULRU",
             format = "latex", booktabs = TRUE,  escape = F, longtable = TRUE,row.names = F) %>%
  kableExtra::kable_styling(full_width = TRUE, latex_options=c("repeat_header")) %>%
  row_spec(0, bold = F, angle = 90) %>%
  row_spec(which(TDmatrix2$exotic==1), bold = TRUE) %>%
  row_spec(1:nrow(TDmatrix2)-1,hline_after=T) %>%
  column_spec(1, width = "5.27cm") %>% 
  column_spec(2:ncol(TDmatrix2), width = ".03cm", border_left = F) %>%
  #column_spec(which(TDconcern_index2=="H"),  color = "red") %>%
  #column_spec(which(TDconcern_index2=="M"),  color = "orange") %>%
  kable_styling(bootstrap_options = "striped", font_size = 9) %>%
  kable_styling(latex_options = c("scale_down", "hold_position"), protect_latex = T) 

  
```

\newpage
# Pictoral guide to most important pests & diseases

## Insect pests
*(these should be arranged logically. My preference would be to organize by type (categories below, from Tree-and-Forest-Health-Guide.pdf), then alphabetically. To make this work, we'll need to insert a column with type in the matrix)*

### Sapsuckers
### Defoliators
### Root/Shoot/Twig Insects
### Bark Beetles/ Wood Borers
#### (insect species )
*(insert brief description of symptoms to look for, pictures)*

## Diseases 
### Rusts
### Root
### Cankers
### Foliage
### Vascular